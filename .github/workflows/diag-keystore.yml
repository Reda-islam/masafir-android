name: Diagnose Keystore

on:
  workflow_dispatch:

jobs:
  diag:
    runs-on: ubuntu-latest
    steps:
      - name: Restore keystore from BASE64
        run: |
          echo "$KEYSTORE_BASE64" | base64 -d > release-keystore.jks
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}

      - name: Check keystore password
        run: |
          if keytool -list -keystore release-keystore.jks -storepass "$KEYSTORE_PASSWORD"; then
            echo "✅ storepass OK"
          else
            echo "❌ storepass WRONG"
            exit 1
          fi
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}

      - name: Check key password
        run: |
          ALIAS=${{ secrets.KEY_ALIAS }}
          if keytool -keypasswd -alias "$ALIAS" \
             -keystore release-keystore.jks \
             -storepass "$KEYSTORE_PASSWORD" \
             -keypass "$KEY_PASSWORD" -new "$KEY_PASSWORD"; then
            echo "✅ keypass OK for alias '$ALIAS'"
          else
            echo "❌ keypass WRONG or alias invalid"
            exit 1
          fi
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
